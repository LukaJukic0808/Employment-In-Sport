<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="http://d3js.org/d3.v7.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
        integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous" />
    <link rel="stylesheet" href="style.css">
    <title>Employment in Sport</title>
</head>

<body style="background-color: #F9E4BC;">
    <div class="page">
        <div class="first-row">
            <div class="map-container">
                <button class="btn btn-outline-primary btn-over-svg" id="euDataButton"
                    onclick="onEUDataClick(this)">European Union</button>
            </div>
            <div class="chart-container">
            </div>
            <div class="settings">
                <h1 class="fw-bold">Employment in sport in Europe</h1>
                <button type="button" class="btn btn-primary" value="play" id="play-pause-button">Play</button>
                <div class="slider-row">
                    <span class="fw-bold">2013</span>
                    <input type="range" name="slider" id="slider" class="form-range" min="2013" max="2022" value="2013"
                        autocomplete="off" steps="1">
                    <span class="fw-bold">2022</span>
                </div>
                <p style="font-size: 30px" class="fw-bold">Year: <span id="year">2013</span>
                <p>
                    <button type="button" class="btn btn-outline-primary filter-button" value="Total employment"
                        id="total" onclick="updateFilterState(this)">TOTAL</button>
                <div class="options">
                    <div class="gender">
                        <h4 class="fw-bold">By gender</h4>
                        <button type="button" class="btn btn-primary filter-button" value="Male employment" id="male"
                            onclick="updateFilterState(this)">Male</button>
                        <button type="button" class="btn btn-outline-primary filter-button" value="Female employment"
                            id="female" onclick="updateFilterState(this)">Female</button>
                    </div>
                    <div class="education">
                        <h4 class="fw-bold">By education level (ISCED 2011)</h4>
                        <button type="button" class="btn btn-outline-primary filter-button"
                            value="Employment of people with primary education" id="primary"
                            onclick="updateFilterState(this)">0-2</button>
                        <button type="button" class="btn btn-outline-primary filter-button"
                            value="Employment of people with secondary education" id="secondary"
                            onclick="updateFilterState(this)">3-4</button>
                        <button type="button" class="btn btn-outline-primary filter-button"
                            value="Employment of people with tertiary education" id="tertiary"
                            onclick="updateFilterState(this)">5-8</button>
                    </div>
                    <div class="age">
                        <h4 class="fw-bold">By age</h4>
                        <button type="button" class="btn btn-outline-primary filter-button"
                            value="People aged 15-29 employment" id="young"
                            onclick="updateFilterState(this)">15-29</button>
                        <button type="button" class="btn btn-outline-primary filter-button"
                            value="People aged 30-64 employment" id="middle"
                            onclick="updateFilterState(this)">30-64</button>
                        <button type="button" class="btn btn-outline-primary filter-button"
                            value="People aged 65+ employment" id="old" onclick="updateFilterState(this)">65+</button>
                    </div>
                </div>
                <div class="overall">
                    <div class="unit">
                        <button type="button" class="btn btn-primary unit-button" id="TH"
                            onclick="updateUnitState(this)">Thousands</button>
                        <button type="button" class="btn btn-outline-primary unit-button" id="PR"
                            onclick="updateUnitState(this)">Percentage</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="second-row">
            <div class="line-chart">
            </div>
            <div class="line-chart-legend">
            </div>
            <div class="genderPieChart">
                <div class="gender-pie"></div>
                <div class="gender-legend">
                    <div id="malePieLegend">
                        <div id="malePieLegendColor"></div>
                        <div>Male</div>
                    </div>
                    <div id="femalePieLegend">
                        <div id="femalePieLegendColor"></div>
                        <div>Female</div>
                    </div>
                    <div id="noDataGenderPieLegend">
                        <div id="noDataPieLegendColor"></div>
                        <div>No data</div>
                    </div>
                </div>
            </div>
            <div class="educationPieChart">
                <div class="education-pie"></div>
                <div class="education-legend">
                    <div id="primaryPieLegend">
                        <div id="primaryPieLegendColor"></div>
                        <div>0-2</div>
                    </div>
                    <div id="secondaryPieLegend">
                        <div id="secondaryPieLegendColor"></div>
                        <div>3-4</div>
                    </div>
                    <div id="tertiaryPieLegend">
                        <div id="tertiaryPieLegendColor"></div>
                        <div>5-8</div>
                    </div>
                    <div id="noDataEducationPieLegend">
                        <div id="noDataPieLegendColor"></div>
                        <div>No data</div>
                    </div>
                </div>
            </div>
            <div class="agePieChart">
                <div class="age-pie"></div>
                <div class="age-legend">
                    <div id="youngPieLegend">
                        <div id="youngPieLegendColor"></div>
                        <div>15-29</div>
                    </div>
                    <div id="middlePieLegend">
                        <div id="middlePieLegendColor"></div>
                        <div>30-64</div>
                    </div>
                    <div id="oldPieLegend">
                        <div id="oldPieLegendColor"></div>
                        <div>65+</div>
                    </div>
                    <div id="noDataAgePieLegend">
                        <div id="noDataPieLegendColor"></div>
                        <div>No data</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="mapMouseText">Placeholder</div>
    <div id="barMouseText">Placeholder</div>
    <div id="lineMouseText">Placeholder</div>
    <div id="pieChartsMouseText">Placeholder</div>
    <script>
        var width = 650;
        var height = 550;
        var currentYear = "2013";
        var currentCountry = "FR";
        var mapMouseText = d3.select("#mapMouseText");
        var lineMouseText = d3.select("#lineMouseText");
        var pieChartsMouseText = d3.select("#pieChartsMouseText");
        var currentSelectionFilter = "male"
        var currentSelectionUnit = "TH"
        var currentTitleString = "Male employment"
        var loadedBarChart = 0;
        var loadedLineChart = 0;
        var loadedGenderPieChart = 0;
        var loadedEducationPieChart = 0;
        var loadedAgePieChart = 0;
        var slider = d3.select("#slider").on("input", updateYear)
        var year = d3.select("#year")
        var formatType;
        var paths;
        let total = [{ "id": "total", "print": "Total" }]
        let gender = [{ "id": "male", "print": "Male" }, { "id": "female", "print": "Female" }]
        let education = [{ "id": "primary", "print": "0-2" }, { "id": "secondary", "print": "3-4" }, { "id": "tertiary", "print": "5-8" }]
        let age = [{ "id": "young", "print": "15-29" }, { "id": "middle", "print": "30-64" }, { "id": "old", "print": "65+" }]
        var currentGroup = { "print": "By gender", "data": gender }
        var sort = "desc"
        var euSwitch = true

        var projection = d3.geoMercator()
            .center([7, 52])
            .translate([height / 2, width / 2])
            .scale(480)
            .rotate([0, 0]);

        var dataJson = null

        var path = d3.geoPath()
            .projection(projection);

        var mapSvg = d3.select(".map-container").append("svg")
            .attr("width", width)
            .attr("height", height)
            .style("background", "#F9E4BC")
            .style("margin-bottom", "12px")
            .call(d3.zoom().on("zoom", zoom))
            .append("g");

        var chart = d3.select(".chart-container")
        var lineChart = d3.select(".line-chart")

        d3.json("europe.topojson").then(function (europe) {
            var data = topojson.feature(europe, europe.objects.europe);
            var states = mapSvg.selectAll("path.county")
                .data(data.features)
                .enter()
                .append("path")
                .attr("class", "county")
                .attr("id", function (d) { return d.id; })
                .attr("d", path)
                .style("fill", "blue")
                .style("stroke", "yellow")
                .style("stroke-width", 0.4)
                .style("stroke-opacity", 1);

            d3.select("#" + currentCountry).style("fill", "#DC3545")
            states.on('click', selectCountry)
            states.on('mouseover', showInfo)
            states.on('mouseout', removeInfo)
            states.on('mousemove', updateInfo)
            d3.json("sport.json").then(function (dataToLoad) {
                dataJson = dataToLoad;
                updateBarChart()
                updateLineChart()
                updateGenderPieChart()
                updateEducationPieChart()
                updateAgePieChart()
                states.style("cursor", function (d) { return (dataJson[d.id] == undefined ? "default" : "pointer") });
            })
        });

        function zoom(event) {
            mapSvg.attr("transform", event.transform);
        }

        // https://d3-graph-gallery.com/graph/barplot_horizontal.html
        function updateBarChart() {
            var svg, xAxis, yAxis, title, xAxisLabel;
            const width = 650;
            const height = 518;
            const marginTop = 30;
            const marginRight = 30;
            const marginBottom = 50;
            const marginLeft = 95;

            keys = Object.keys(dataJson)
            var names = [];
            var values = [];
            keys.forEach(key => {
                if (!euSwitch) {
                    if (key == "EU27_2020") {
                        return;
                    }
                }
                value = dataJson[key][currentYear][currentSelectionFilter + currentSelectionUnit]
                name = dataJson[key]["name"]
                if (value != null) {
                    values.push({ "name": name, "abbr": key, "value": value })
                }
            });

            if (sort == "desc") {
                values.sort((a, b) => a.value - b.value);
            } else {
                values.sort((a, b) => b.value - a.value);
            }
            names = values.map(item => item.name);

            if (loadedBarChart == 0) {

                svg = chart
                    .append("svg")
                    .attr("id", "chart")
                    .attr("width", width)
                    .attr("height", height)
                    .style("background", "#F9E4BC")

                xAxis = svg
                    .append("g")
                    .attr("class", "xaxis")
                    .attr("transform", `translate(0,${height - marginBottom})`);

                yAxis = svg
                    .append("g")
                    .attr("class", "yaxis")
                    .attr("transform", `translate(${marginLeft},0)`);

                title = svg
                    .append("text")
                    .attr("class", "chart-title")
                    .attr("transform", `translate(${(width / 2) + 24},15)`)
                    .style("text-anchor", "middle")
                    .attr("fill", "blue");

                xAxisLabel = svg
                    .append("text")
                    .attr("class", "x-axis-label")
                    .attr("transform", `translate(${(width / 2) + 24},${height - marginBottom + 40})`)
                    .style("text-anchor", "middle");

                var buttonContainer = chart.append("div")
                    .attr("id", "button-container")
                    .style("position", "relative")
                    .style("bottom", "10px")
                    .style("right", "10px");

                var switchContainer = buttonContainer.append("div")
                    .attr("class", "form-check form-switch")
                    .style("margin-left", "60px");

                switchContainer.append("input")
                    .attr("class", "form-check-input")
                    .attr("type", "checkbox")
                    .attr("id", "euSwitch")
                    .attr("checked", true)
                    .style("cursor", "pointer")
                    .on("change", function () {
                        euSwitch = d3.select(this).property("checked");
                        updateBarChart();
                    });

                switchContainer.append("label")
                    .attr("class", "form-check-label text-primary")
                    .attr("for", "euSwitch")
                    .text("Include EU")
                    .style("font-weight", "bold")

                var sortContainer = buttonContainer.append("div")

                sortContainer.append("button")
                    .attr("id", "asc")
                    .text("Ascending")
                    .attr("class", "btn btn-outline-primary")
                    .on("click", function () {
                        if (sort === "desc") {
                            sort = "asc";
                            d3.select("#asc").attr("class", "btn btn-primary");
                            d3.select("#desc").attr("class", "btn btn-outline-primary");
                            updateBarChart();
                        }
                    });

                sortContainer.append("button")
                    .attr("id", "desc")
                    .text("Descending")
                    .attr("class", "btn btn-primary")
                    .style("margin-left", "5px")
                    .on("click", function () {
                        if (sort === "asc") {
                            sort = "desc";
                            d3.select("#asc").attr("class", "btn btn-outline-primary");
                            d3.select("#desc").attr("class", "btn btn-primary");
                            updateBarChart();
                        }
                    });

                loadedBarChart = 1;
            } else {
                svg = d3.select("#chart");
                xAxis = svg.select(".xaxis");
                yAxis = svg.select(".yaxis");
                title = svg.select(".chart-title");
                xAxisLabel = svg.select(".x-axis-label");
            }


            const x = d3.scaleLinear()
                .domain([0, d3.max(values, function (d) { return d.value })])
                .range([marginLeft, width - marginRight]);

            const y = d3.scaleBand()
                .domain(names)
                .range([height - marginBottom, marginTop]).padding(0.25);

            if (currentSelectionUnit === "TH") {
                formatType = ".2s"
                xAxisLabel.text("Thousands of people");
            } else {
                formatType = ".1f"
                xAxisLabel.text("Percentage (%)");
            }

            xAxis
                .transition()
                .duration(500)
                .call(d3.axisBottom(x).tickFormat(d3.format(formatType)));

            yAxis.call(d3.axisLeft(y));

            title.text(currentTitleString);

            const rects = svg.selectAll("rect").data(values);

            rects.join(
                enter =>
                    enter
                        .append("rect")
                        .attr("x", x.range()[0])
                        .attr("style", "cursor:pointer")
                        .attr("y", (d) => y(d.name))
                        .attr("id", (d) => d.abbr + "_bar")
                        .attr("height", y.bandwidth())
                        .attr("fill", d => d.abbr === currentCountry ? "#DC3545" : "blue")
                        .attr("width", d => {
                            return x(d.value) - x.range()[0];
                        })
                        .on("click", function (event, d) {
                            var selectedBarCountry = this.id.slice(0, 2)
                            if (!(selectedBarCountry === currentCountry)) {
                                d3.select("#" + currentCountry).style("fill", "blue")
                                d3.select("#" + currentCountry + "_bar").style("fill", "blue")
                                if (selectedBarCountry === "EU") {
                                    var euDataBtn = document.getElementById("euDataButton")
                                    euDataBtn.classList.remove("btn-outline-primary")
                                    euDataBtn.classList.add("btn-danger")
                                    currentCountry = "EU27_2020"
                                } else {
                                    var previousCurrentCountry = currentCountry
                                    currentCountry = selectedBarCountry
                                    d3.select("#" + currentCountry).style("fill", "#DC3545")
                                    if (previousCurrentCountry === "EU27_2020") {
                                        var euDataBtn = document.getElementById("euDataButton")
                                        euDataBtn.classList.remove("btn-danger")
                                        euDataBtn.classList.add("btn-outline-primary")
                                    }
                                }
                                updateLineChart()
                                updateGenderPieChart()
                                updateEducationPieChart()
                                updateAgePieChart()
                            }
                        })
                        .on("mouseover", function (event, d) {
                            d3.select(this)
                                .style("fill", "orange");
                            d3.select("#barMouseText")
                                .style("left", (event.pageX + 5) + "px")
                                .style("top", (event.pageY - 35) + "px")
                                .transition()
                                .duration(200)
                                .style("opacity", 1);
                            d3.select("#barMouseText").html(d.value);
                        })
                        .on("mouseout", function (event, d) {
                            if (d.abbr === currentCountry) {
                                d3.select(this).style("fill", "#DC3545");
                            } else {
                                d3.select(this).style("fill", "blue")
                            }
                            d3.select("#barMouseText")
                                .transition()
                                .duration(500)
                                .style("opacity", 0);
                        }),
                update =>
                    update
                        .transition()
                        .duration(600)
                        .delay((d, i) => i * 10)
                        .attr("y", d => y(d.name))
                        .attr("id", (d) => d.abbr + "_bar")
                        .attr("height", y.bandwidth())
                        .attr("width", d => {
                            return x(d.value) - x.range()[0];
                        })
                        .on('start', function (d) {
                            if (d.abbr === currentCountry) {
                                d3.select(this).style("fill", "#DC3545");
                            } else {
                                d3.select(this).style("fill", "blue")
                            }
                        }),
                exit => exit.remove()
            );
            d3.select("#" + currentCountry + "_bar").style("fill", "#DC3545");
        }

        // https://d3-graph-gallery.com/graph/line_basic.html
        function updateLineChart() {
            var svg, xAxis, yAxis, title, unitText, lineUnit;
            var groupIterator = 0;
            const width = 700;
            const height = 330;
            const marginTop = 30;
            const marginRight = 30;
            const marginBottom = 30;
            const marginLeft = 40;
            var colors = ["red", "green", "blue"]
            var showLegend = [false, false, false]
            var hasSomethingToShow = false

            years = ["2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021", "2022"]
            var valuesCombinded = [];

            currentGroup["data"].forEach(group => {
                var values = []
                years.forEach(year => {
                    value = dataJson[currentCountry][year][group["id"] + currentSelectionUnit]
                    if (value != null) {
                        values.push({ "year": year, "value": value })
                    }
                });
                if (values.length > 1) {
                    showLegend[groupIterator] = true
                    hasSomethingToShow = true
                } else {
                    values = []
                }
                valuesCombinded.push(values)
                groupIterator += 1
            });

            if (currentSelectionUnit === "TH") {
                unitText = "Thousands"
                formatType = ".2s"
            } else {
                unitText = "Percentage (%)"
                formatType = ".1f"
            }

            const x = d3.scaleUtc(d3.extent(years), [marginLeft, width - marginRight]);

            var y;

            if (!hasSomethingToShow) {
                y = d3.scaleLinear()
                    .domain([0, 10])
                    .range([height - marginBottom, marginTop]);
            } else {
                y = d3.scaleLinear()
                    .domain([0, d3.max(valuesCombinded, function (values) {
                        return d3.max(values, function (d) { return d.value })
                    })])
                    .range([height - marginBottom, marginTop]);
            }

            if (loadedLineChart == 0) {
                svg = lineChart.append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("viewBox", [0, 0, width, height])
                    .attr("style", "max-width: 100%; height: auto; height: intrinsic; background:#F9E4BC");

                xAxis = svg.append("g")
                    .attr("transform", `translate(0,${height - marginBottom})`)
                    .attr("class", "line-x-axis")

                yAxis = svg.append("g")
                    .attr("transform", `translate(${marginLeft},0)`)
                    .attr("class", "line-y-axis")

                unit = yAxis.call(g => g.append("text")
                    .attr("x", -(marginLeft - 10))
                    .attr("y", 10)
                    .attr("id", "line-unit")
                    .attr("fill", "black")
                    .attr("text-anchor", "start")
                    .text(unitText))

                lineUnit = d3.select("#line-unit")

                title = svg
                    .append("text")
                    .attr("class", "line_chart_title")
                    .attr("transform", `translate(${width / 2},15)`)
                    .style("text-anchor", "middle")
                    .style("font-weight", "bold")
                    .attr("fill", "blue");

                paths = []

                for (let i = 0; i < currentGroup["data"].length; i++) {
                    paths.push(
                        svg.append("path")
                            .attr("class", "line")
                            .attr("fill", "none")
                            .attr("stroke", colors[i])
                            .attr("stroke-width", 3)
                    )
                }

                for (let i = 0; i < currentGroup["data"].length; i++) {
                    svg.append("g")
                        .attr("class", "circle-group-" + i)
                        .selectAll("circle")
                        .data(valuesCombinded[i])
                        .enter()
                        .append("circle")
                        .attr("r", 5)
                        .attr("fill", colors[i])
                        .attr("stroke", "black")
                        .attr("cx", d => x(d.year))
                        .attr("cy", d => y(d.value))
                        .style("display", "none")
                        .style("cursor", "context-menu")
                        .on("mouseover", function (event, d) {
                            d3.select("#lineMouseText")
                                .style("left", (event.pageX + 5) + "px")
                                .style("top", (event.pageY - 35) + "px")
                                .style("opacity", "1")
                                .style("background-color", colors[i])
                                .html(d.value);
                        })
                        .on("mouseout", function (event, d) {
                            d3.select("#lineMouseText")
                                .style("opacity", "0");
                        });
                }

                svg.on("mouseenter", function () {
                    svg.selectAll("circle").style("display", "block");
                })
                svg.on("mouseleave", function () {
                    svg.selectAll("circle").style("display", "none");
                })

                loadedLineChart = 1

            } else {
                svg = lineChart.select("svg")
                lineUnit = d3.select("#line-unit")
                xAxis = svg.select(".line-x-axis")
                yAxis = svg.select(".line-y-axis")
                title = svg.select(".line_chart_title")
                svg.select(".grid-lines").remove()
            }

            if (currentGroup["data"].length < paths.length) {
                var pathsLength = paths.length
                for (let i = 0; i < (pathsLength - currentGroup["data"].length); i++) {
                    paths[pathsLength - 1 - i].remove()
                    paths.pop()
                }
            } else if (paths.length < currentGroup["data"].length) {
                var pathsLength = paths.length
                for (let i = 0; i < (currentGroup["data"].length - pathsLength); i++) {
                    paths.push(
                        svg.append("path")
                            .attr("class", "line")
                            .attr("fill", "none")
                            .attr("stroke", colors[pathsLength + i])
                            .attr("stroke-width", 3)
                    )
                }
            }

            lineUnit.text(unitText)
            title.text(currentGroup["print"] + " in " + dataJson[currentCountry]["name"])

            yGrid = (g) => g
                .attr('class', 'grid-lines')
                .selectAll('line')
                .data(y.ticks())
                .join('line')
                .attr('x1', marginLeft)
                .attr('x2', width - marginRight)
                .attr('y1', d => y(d))
                .attr('y2', d => y(d))
                .attr("stroke", "#000000")
                .attr("stroke-opacity", 0.25)

            xAxis.call(d3.axisBottom(x).tickFormat(d3.format(".4")));

            yAxis.call(d3.axisLeft(y).ticks(height / 40).tickFormat(d3.format(formatType)))

            svg.append('g').call(yGrid)

            const line = d3.line()
                .x((d) => x(d.year))
                .y(d => y(d.value));

            for (let i = 0; i < showLegend.length; i++) {
                d3.select(".color-line-chart-" + i).remove()
            }

            for (let i = 0; i < currentGroup["data"].length; i++) {
                paths[i].transition()
                    .duration(750)
                    .attr("d", line(valuesCombinded[i]));
                if (showLegend[i]) {
                    var colorContainer = d3.select(".line-chart-legend")
                        .append("div")
                        .attr("class", "color-line-chart-" + i)
                    colorContainer.append("div")
                        .attr("style", "height: 10px; width: 10px; background-color: " + colors[i])
                    colorContainer.append("div")
                        .attr("class", "color-text-" + i)
                        .text(currentGroup["data"][i]["print"])
                } else {
                    d3.select(".color-line-chart-" + i).remove()
                }
            }

            for (let i = 0; i < 3; i++) {
                let circleGroup = svg.select(".circle-group-" + i);
                if (circleGroup.empty()) {
                    circleGroup = svg.append("g")
                        .attr("class", "circle-group-" + i);
                }

                var points = []

                if (i < currentGroup["data"].length) {
                    points = valuesCombinded[i]
                }

                let circles = circleGroup.selectAll("circle")
                    .data(points);

                circles.enter()
                    .append("circle")
                    .attr("r", 5)
                    .attr("fill", colors[i])
                    .attr("stroke", "black")
                    .merge(circles)
                    .attr("cx", d => x(d.year))
                    .attr("cy", d => y(d.value))
                    .style("display", "none")
                    .style("cursor", "context-menu")
                    .on("mouseover", function (event, d) {
                        d3.select("#lineMouseText")
                            .style("left", (event.pageX + 5) + "px")
                            .style("top", (event.pageY - 35) + "px")
                            .style("opacity", "1")
                            .style("background-color", colors[i])
                            .html(d.value);
                    })
                    .on("mouseout", function (event, d) {
                        d3.select("#lineMouseText")
                            .style("opacity", "0");
                    });;

                circles.exit().remove();
            }
        }

        // https://d3-graph-gallery.com/graph/pie_changeData.html
        function updateGenderPieChart() {
            var svg, arcs, title;
            const width = 300;
            const height = 260;
            const marginTop = 40;
            const radius = Math.max(width, height) / 2 - marginTop;

            if (loadedGenderPieChart == 0) {
                svg = d3.select(".gender-pie")
                    .append("svg")
                    .attr("id", "genderChart")
                    .attr("width", width)
                    .attr("height", height)
                    .append("g")
                    .attr("transform", `translate(${width / 2},${height / 2 + marginTop/2 - 5})`);

                title = svg
                    .append("text")
                    .attr("class", "chart-title")
                    .attr("transform", `translate(0,${-height / 2})`)
                    .style("text-anchor", "middle")
                    .attr("fill", "blue");

                loadedGenderPieChart = 1;
            } else {
                svg = d3.select("#genderChart");
                title = svg.select(".chart-title");
            }

            var maleValueToShow;
            var femaleValueToShow;

            if (currentSelectionUnit == "TH") {
                maleValueToShow = dataJson[currentCountry][currentYear]["maleTH"]
                femaleValueToShow = dataJson[currentCountry][currentYear]["femaleTH"]
            } else {
                var total = dataJson[currentCountry][currentYear]["femaleTH"] + dataJson[currentCountry][currentYear]["maleTH"]
                maleValueToShow = (dataJson[currentCountry][currentYear]["maleTH"] / total * 100).toFixed(2);
                femaleValueToShow = (dataJson[currentCountry][currentYear]["femaleTH"] / total * 100).toFixed(2);
            }

            var maleData = {
                label: "Male", value: dataJson[currentCountry][currentYear]["maleTH"],
                toShow: maleValueToShow, color: "red", hoverValue: true
            }
            var femaleData = {
                label: "Female", value: dataJson[currentCountry][currentYear]["femaleTH"],
                toShow: femaleValueToShow, color: "green", hoverValue: true
            }
            var noData = { label: "No data", value: 0, color: "grey", hoverValue: false }

            var hasData = false;
            var genderData = [];

            if (maleData.value == null) {
                d3.select("#malePieLegend").style("display", "none")
                maleData.value = 0
            } else {
                hasData = true
                d3.select("#malePieLegend").style("display", "flex")
            }
            genderData.push(maleData)

            if (femaleData.value == null) {
                d3.select("#femalePieLegend").style("display", "none")
                femaleData.value = 0
            } else {
                hasData = true
                d3.select("#femalePieLegend").style("display", "flex")
            }
            genderData.push(femaleData)

            if (!hasData) {
                d3.select("#noDataGenderPieLegend").style("display", "flex")
                noData.value = 1
            } else {
                d3.select("#noDataGenderPieLegend").style("display", "none")
            }

            genderData.push(noData)

            const pie = d3.pie().value(d => d.value)
                .sort(function (a, b) { return d3.ascending(a.label, b.label) })
                (genderData);
            const arc = d3.arc().innerRadius(0).outerRadius(radius);

            title.text(`Gender distribution in ${dataJson[currentCountry]["name"]}`);

            const arcGroup = svg.selectAll(".arc").data(pie);

            arcGroup.join(
                enter => {
                    const arcEnter = enter.append("g").attr("class", "arc");
                    arcEnter.append("path")
                        .attr("d", arc)
                        .attr("fill", d => d.data.color)
                        .each(function (d) { this._current = d; })
                        .style("cursor", "context-menu")
                        .on("mouseover", function (event, d) {
                            pieChartsMouseText.transition().duration(200).style("opacity", 0.9);
                            pieChartsMouseText.html(d.data.hoverValue ? `${d.data.label}: ${d.data.toShow}` : `No data`)
                                .style("left", (event.pageX + 5) + "px")
                                .style("top", (event.pageY - 28) + "px")
                                .style("background-color", d.data.color);
                        })
                        .on("mouseout", function () {
                            pieChartsMouseText.transition().duration(500).style("opacity", 0);
                        });;
                },
                update => {
                    update.select("path")
                        .transition()
                        .duration(750)
                        .attrTween("d", function (d) {
                            const i = d3.interpolate(this._current, d);
                            this._current = i(0);
                            return t => arc(i(t));
                        })
                        .attr("fill", d => d.data.color);
                },
                exit => exit.remove()
            );
        }

        // https://d3-graph-gallery.com/graph/pie_changeData.html
        function updateEducationPieChart() {
            var svg, arcs, title;
            const width = 300;
            const height = 260;
            const marginTop = 40;
            const radius = Math.max(width, height) / 2 - marginTop;

            if (loadedEducationPieChart == 0) {
                svg = d3.select(".education-pie")
                    .append("svg")
                    .attr("id", "educationChart")
                    .attr("width", width)
                    .attr("height", height)
                    .append("g")
                    .attr("transform", `translate(${width / 2},${height / 2 + marginTop/2 - 5})`);

                title = svg
                    .append("text")
                    .attr("class", "chart-title")
                    .attr("transform", `translate(0,${-height / 2})`)
                    .style("text-anchor", "middle")
                    .attr("fill", "blue");

                loadedEducationPieChart = 1;
            } else {
                svg = d3.select("#educationChart");
                title = svg.select(".chart-title");
            }

            var primaryValueToShow;
            var secondaryValueToShow;
            var tertiaryValueToShow;

            if (currentSelectionUnit == "TH") {
                primaryValueToShow = dataJson[currentCountry][currentYear]["primaryTH"]
                secondaryValueToShow = dataJson[currentCountry][currentYear]["secondaryTH"]
                tertiaryValueToShow = dataJson[currentCountry][currentYear]["tertiaryTH"]
            } else {
                var total = dataJson[currentCountry][currentYear]["primaryTH"] + 
                    dataJson[currentCountry][currentYear]["secondaryTH"] +                 
                    dataJson[currentCountry][currentYear]["tertiaryTH"]

                primaryValueToShow = (dataJson[currentCountry][currentYear]["primaryTH"] / total * 100).toFixed(2);
                secondaryValueToShow = (dataJson[currentCountry][currentYear]["secondaryTH"] / total * 100).toFixed(2);
                tertiaryValueToShow = (dataJson[currentCountry][currentYear]["tertiaryTH"] / total * 100).toFixed(2);
            }

            var primaryData = {
                label: "0-2", value: dataJson[currentCountry][currentYear]["primaryTH"],
                toShow: primaryValueToShow, color: "red", hoverValue: true
            }
            var secondaryData = {
                label: "3-4", value: dataJson[currentCountry][currentYear]["secondaryTH"],
                toShow: secondaryValueToShow, color: "green", hoverValue: true
            }
            var tertiaryData = {
                label: "5-8", value: dataJson[currentCountry][currentYear]["tertiaryTH"],
                toShow: tertiaryValueToShow, color: "blue", hoverValue: true
            }
            var noData = { label: "No data", value: 0, color: "grey", hoverValue: false }

            var hasData = false;
            var educationData = [];

            if (primaryData.value == null) {
                d3.select("#primaryPieLegend").style("display", "none")
                primaryData.value = 0
            } else {
                hasData = true
                d3.select("#primaryPieLegend").style("display", "flex")
            }
            educationData.push(primaryData)

            if (secondaryData.value == null) {
                d3.select("#secondaryPieLegend").style("display", "none")
                secondaryData.value = 0
            } else {
                hasData = true
                d3.select("#secondaryPieLegend").style("display", "flex")
            }
            educationData.push(secondaryData)

            if (tertiaryData.value == null) {
                d3.select("#tertiaryPieLegend").style("display", "none")
                tertiaryData.value = 0
            } else {
                hasData = true
                d3.select("#tertiaryPieLegend").style("display", "flex")
            }
            educationData.push(tertiaryData)

            if (!hasData) {
                d3.select("#noDataEducationPieLegend").style("display", "flex")
                noData.value = 1
            } else {
                d3.select("#noDataEducationPieLegend").style("display", "none")
            }

            educationData.push(noData)

            const pie = d3.pie().value(d => d.value)
                .sort(function (a, b) { return d3.ascending(a.label, b.label) })
                (educationData);
            const arc = d3.arc().innerRadius(0).outerRadius(radius);

            title.text(`Education distribution in ${dataJson[currentCountry]["name"]}`);

            const arcGroup = svg.selectAll(".arc").data(pie);

            arcGroup.join(
                enter => {
                    const arcEnter = enter.append("g").attr("class", "arc");
                    arcEnter.append("path")
                        .attr("d", arc)
                        .attr("fill", d => d.data.color)
                        .each(function (d) { this._current = d; })
                        .style("cursor", "context-menu")
                        .on("mouseover", function (event, d) {
                            pieChartsMouseText.transition().duration(200).style("opacity", 0.9);
                            pieChartsMouseText.html(d.data.hoverValue ? `${d.data.label}: ${d.data.toShow}` : `No data`)
                                .style("left", (event.pageX + 5) + "px")
                                .style("top", (event.pageY - 28) + "px")
                                .style("background-color", d.data.color);
                        })
                        .on("mouseout", function () {
                            pieChartsMouseText.transition().duration(500).style("opacity", 0);
                        });;
                },
                update => {
                    update.select("path")
                        .transition()
                        .duration(750)
                        .attrTween("d", function (d) {
                            const i = d3.interpolate(this._current, d);
                            this._current = i(0);
                            return t => arc(i(t));
                        })
                        .attr("fill", d => d.data.color);
                },
                exit => exit.remove()
            );
        }

        // https://d3-graph-gallery.com/graph/pie_changeData.html
        function updateAgePieChart() {
            var svg, arcs, title;
            const width = 300;
            const height = 260;
            const marginTop = 40;
            const radius = Math.max(width, height) / 2 - marginTop;

            if (loadedAgePieChart == 0) {
                svg = d3.select(".age-pie")
                    .append("svg")
                    .attr("id", "ageChart")
                    .attr("width", width)
                    .attr("height", height)
                    .append("g")
                    .attr("transform", `translate(${width / 2},${height / 2 + marginTop/2 - 5})`);

                title = svg
                    .append("text")
                    .attr("class", "chart-title")
                    .attr("transform", `translate(0,${-height / 2})`)
                    .style("text-anchor", "middle")
                    .attr("fill", "blue");

                loadedAgePieChart = 1;
            } else {
                svg = d3.select("#ageChart");
                title = svg.select(".chart-title");
            }

            var youngValueToShow;
            var middleValueToShow;
            var oldValueToShow;

            if (currentSelectionUnit == "TH") {
                youngValueToShow = dataJson[currentCountry][currentYear]["youngTH"]
                middleValueToShow = dataJson[currentCountry][currentYear]["middleTH"]
                oldValueToShow = dataJson[currentCountry][currentYear]["oldTH"]
            } else {
                var total = dataJson[currentCountry][currentYear]["youngTH"] + 
                    dataJson[currentCountry][currentYear]["middleTH"] +                 
                    dataJson[currentCountry][currentYear]["oldTH"]

                youngValueToShow = (dataJson[currentCountry][currentYear]["youngTH"] / total * 100).toFixed(2);
                middleValueToShow = (dataJson[currentCountry][currentYear]["middleTH"] / total * 100).toFixed(2);
                oldValueToShow = (dataJson[currentCountry][currentYear]["oldTH"] / total * 100).toFixed(2);
            }

            var youngData = {
                label: "15-29", value: dataJson[currentCountry][currentYear]["youngTH"],
                toShow: youngValueToShow, color: "red", hoverValue: true
            }
            var middleData = {
                label: "30-64", value: dataJson[currentCountry][currentYear]["middleTH"],
                toShow: middleValueToShow, color: "green", hoverValue: true
            }
            var oldData = {
                label: "65+", value: dataJson[currentCountry][currentYear]["oldTH"],
                toShow: oldValueToShow, color: "blue", hoverValue: true
            }
            var noData = { label: "No data", value: 0, color: "grey", hoverValue: false }

            var hasData = false;
            var ageData = [];

            if (youngData.value == null) {
                d3.select("#youngPieLegend").style("display", "none")
                youngData.value = 0
            } else {
                hasData = true
                d3.select("#youngPieLegend").style("display", "flex")
            }
            ageData.push(youngData)

            if (middleData.value == null) {
                d3.select("#middlePieLegend").style("display", "none")
                middleData.value = 0
            } else {
                hasData = true
                d3.select("#middlePieLegend").style("display", "flex")
            }
            ageData.push(middleData)

            if (oldData.value == null) {
                d3.select("#oldPieLegend").style("display", "none")
                oldData.value = 0
            } else {
                hasData = true
                d3.select("#oldPieLegend").style("display", "flex")
            }
            ageData.push(oldData)

            if (!hasData) {
                d3.select("#noDataAgePieLegend").style("display", "flex")
                noData.value = 1
            } else {
                d3.select("#noDataAgePieLegend").style("display", "none")
            }

            ageData.push(noData)

            const pie = d3.pie().value(d => d.value)
                .sort(function (a, b) { return d3.ascending(a.label, b.label) })
                (ageData);
            const arc = d3.arc().innerRadius(0).outerRadius(radius);

            title.text(`Age distribution in ${dataJson[currentCountry]["name"]}`);

            const arcGroup = svg.selectAll(".arc").data(pie);

            arcGroup.join(
                enter => {
                    const arcEnter = enter.append("g").attr("class", "arc");
                    arcEnter.append("path")
                        .attr("d", arc)
                        .attr("fill", d => d.data.color)
                        .each(function (d) { this._current = d; })
                        .style("cursor", "context-menu")
                        .on("mouseover", function (event, d) {
                            pieChartsMouseText.transition().duration(200).style("opacity", 0.9);
                            pieChartsMouseText.html(d.data.hoverValue ? `${d.data.label}: ${d.data.toShow}` : `No data`)
                                .style("left", (event.pageX + 5) + "px")
                                .style("top", (event.pageY - 28) + "px")
                                .style("background-color", d.data.color);
                        })
                        .on("mouseout", function () {
                            pieChartsMouseText.transition().duration(500).style("opacity", 0);
                        });;
                },
                update => {
                    update.select("path")
                        .transition()
                        .duration(750)
                        .attrTween("d", function (d) {
                            const i = d3.interpolate(this._current, d);
                            this._current = i(0);
                            return t => arc(i(t));
                        })
                        .attr("fill", d => d.data.color);
                },
                exit => exit.remove()
            );
        }

        function selectCountry(element) {
            if (dataJson[this.id] != undefined) {
                d3.select("#" + currentCountry).style("fill", "blue")
                d3.select("#" + currentCountry + "_bar").style("fill", "blue")
                var previousCurrentCountry = currentCountry
                currentCountry = this.id
                d3.select("#" + currentCountry).style("fill", "#DC3545")
                d3.select("#" + currentCountry + "_bar").style("fill", "#DC3545")
                if (previousCurrentCountry === "EU27_2020") {
                    var euDataBtn = document.getElementById("euDataButton")
                    euDataBtn.classList.remove("btn-danger")
                    euDataBtn.classList.add("btn-outline-primary")
                }
                updateLineChart()
                updateGenderPieChart()
                updateEducationPieChart()
                updateAgePieChart()
            }
        }

        function updateFilterState(element) {
            var buttons = document.querySelectorAll(".filter-button")
            buttons.forEach(it => {
                it.classList.remove("btn-outline-primary");
                it.classList.remove("btn-primary");
                if (it != element) {
                    it.classList.add("btn-outline-primary");
                } else {
                    it.classList.add("btn-primary");
                }
            });
            currentTitleString = element.value
            currentSelectionFilter = element.id

            switch (currentSelectionFilter) {
                case "male":
                case "female":
                    currentGroup["print"] = "By gender"
                    currentGroup["data"] = gender
                    break;

                case "young":
                case "middle":
                case "old":
                    currentGroup["print"] = "By age"
                    currentGroup["data"] = age
                    break;

                case "primary":
                case "secondary":
                case "tertiary":
                    currentGroup["print"] = "By education level"
                    currentGroup["data"] = education
                    break;

                default:
                    currentGroup["print"] = "Total"
                    currentGroup["data"] = total
            }

            updateBarChart();
            updateLineChart();
        }

        function updateUnitState(element) {
            var buttons = document.querySelectorAll(".unit-button")
            buttons.forEach(it => {
                it.classList.remove("btn-outline-primary");
                it.classList.remove("btn-primary");
                if (it != element) {
                    it.classList.add("btn-outline-primary");
                } else {
                    it.classList.add("btn-primary");
                }
            });
            currentSelectionUnit = element.id
            updateBarChart();
            updateLineChart();
            updateGenderPieChart();
            updateEducationPieChart();
            updateAgePieChart()
        }

        var intervalId;
        var isPlaying = false;
        var playPauseButton = d3.select("#play-pause-button");

        // https://gist.github.com/officeofjane/47d2b0bfeecfcb41d2212d06d095c763#file-index-html
        playPauseButton.on("click", function () {
            if (isPlaying) {
                clearInterval(intervalId);
                playPauseButton.text("Play");
                playPauseButton.attr("class", "btn btn-primary")
            } else {
                intervalId = setInterval(function () {
                    var currentValue = +slider.node().value;
                    if (currentValue < +slider.attr("max")) {
                        slider.node().value = currentValue + 1;
                    } else {
                        slider.node().value = slider.attr("min");
                    }
                    updateYear.call(slider.node());
                }, 2000);
                playPauseButton.text("Pause");
                playPauseButton.attr("class", "btn btn-danger")
            }
            isPlaying = !isPlaying;
        });

        function updateYear() {
            year.text(this.value)
            currentYear = this.value
            updateBarChart();
            updateGenderPieChart()
            updateEducationPieChart()
            updateAgePieChart()
        }

        function onEUDataClick(element) {
            d3.select("#" + currentCountry).style("fill", "blue")
            element.classList.remove("btn-outline-primary")
            element.classList.add("btn-danger")
            d3.select("#" + currentCountry + "_bar").style("fill", "blue")
            currentCountry = "EU27_2020"
            d3.select("#" + currentCountry + "_bar").style("fill", "#DC3545")
            updateLineChart()
            updateGenderPieChart()
            updateEducationPieChart()
            updateAgePieChart()
        }

        function showInfo(event) {
            if (dataJson[this.id] == undefined) {
                mapMouseText.text("Data for this country is unavailable")
            } else {
                mapMouseText.text(dataJson[this.id]["name"])
            }
            mapMouseText.style("left", event.clientX + window.scrollX + "px")
            mapMouseText.style("top", event.clientY + 50 + window.scrollY + "px")
            mapMouseText.style("display", "block")
        }

        function removeInfo(event) {
            mapMouseText.style("display", "none")
        }

        function updateInfo(event) {
            mapMouseText.style("left", event.clientX + window.scrollX + "px")
            mapMouseText.style("top", event.clientY - 40 + window.scrollY + "px")
        }
    </script>
</body>

</html>