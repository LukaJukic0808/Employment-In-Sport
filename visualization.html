<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="http://d3js.org/d3.v7.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
        integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous" />
    <link rel="stylesheet" href="style.css">
</head>

<body style="background-color: #F9E4BC;">
    <div class="page">
        <div class="first-row">
            <div class="map-container">
            </div>
            <div class="chart-container">
            </div>
            <div class="settings">
                <h1 class="fw-bold">Employment in sport in Europe</h1>
                <button type="button" class="btn btn-primary" value="play" id="play-pause-button">Play</button>
                <div class="slider-row">
                    <span class="fw-bold">2013</span>
                    <input type="range" name="slider" id="slider" class="form-range" min="2013" max="2022" value="2013"
                        autocomplete="off" steps="1">
                    <span class="fw-bold">2022</span>
                </div>
                <p style="font-size: 30px" class="fw-bold">Year: <span id="year">2013</span>
                <p>
                    <button type="button" class="btn btn-outline-primary filter-button" value="Total employment"
                        id="total" onclick="updateFilterState(this)">TOTAL</button>
                <div class="options">
                    <div class="gender">
                        <h4 class="fw-bold">By gender</h4>
                        <button type="button" class="btn btn-primary filter-button" value="Male employment" id="male"
                            onclick="updateFilterState(this)">Male</button>
                        <button type="button" class="btn btn-outline-primary filter-button" value="Female employment"
                            id="female" onclick="updateFilterState(this)">Female</button>
                    </div>
                    <div class="education">
                        <h4 class="fw-bold">By education level (ISCED 2011)</h4>
                        <button type="button" class="btn btn-outline-primary filter-button"
                            value="Employment of people with primary education" id="primary"
                            onclick="updateFilterState(this)">0-2</button>
                        <button type="button" class="btn btn-outline-primary filter-button"
                            value="Employment of people with secondary education" id="secondary"
                            onclick="updateFilterState(this)">3-4</button>
                        <button type="button" class="btn btn-outline-primary filter-button"
                            value="Employment of people with tertiary education" id="tertiary"
                            onclick="updateFilterState(this)">5-8</button>
                    </div>
                    <div class="age">
                        <h4 class="fw-bold">By age</h4>
                        <button type="button" class="btn btn-outline-primary filter-button"
                            value="People aged 15-29 employment" id="young"
                            onclick="updateFilterState(this)">15-29</button>
                        <button type="button" class="btn btn-outline-primary filter-button"
                            value="People aged 30-64 employment" id="middle"
                            onclick="updateFilterState(this)">30-64</button>
                        <button type="button" class="btn btn-outline-primary filter-button"
                            value="People aged 65+ employment" id="old" onclick="updateFilterState(this)">65+</button>
                    </div>
                </div>
                <div class="overall">
                    <div class="unit">
                        <button type="button" class="btn btn-primary unit-button" id="TH"
                            onclick="updateUnitState(this)">Thousands</button>
                        <button type="button" class="btn btn-outline-primary unit-button" id="PR"
                            onclick="updateUnitState(this)">Percentage</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="second-row">
            <div class="line-chart">
            </div>
            <div class="line-chart-legend">
            </div>
            <div class="graph2">
            </div>
            <div class="graph3">
            </div>
        </div>
    </div>
    <script>
        var width = 650;
        var height = 550;
        var currentYear = "2013";
        var currentCountry = "FR";
        var currentSelectionFilter = "male"
        var currentSelectionUnit = "TH"
        var currentTitleString = "Male employment"
        var loadedBarChart = 0;
        var loadedLineChart = 0;
        var slider = d3.select("#slider").on("input", updateYear)
        var year = d3.select("#year")
        var formatType;
        var paths;
        let total = [{ "id": "total", "print": "Total" }]
        let gender = [{ "id": "male", "print": "Male" }, { "id": "female", "print": "Female" }]
        let education = [{ "id": "primary", "print": "0-2" }, { "id": "secondary", "print": "3-4" }, { "id": "tertiary", "print": "5-8" }]
        let age = [{ "id": "young", "print": "15-29" }, { "id": "middle", "print": "30-64" }, { "id": "old", "print": "65+" }]
        var currentGroup = { "print": "By gender", "data": gender }
        var sort = "desc"

        var projection = d3.geoMercator()
            .center([7, 54])
            .translate([height / 2, width / 2])
            .scale(500)
            .rotate([0, 0]);

        var dataJson = null

        var path = d3.geoPath()
            .projection(projection);

        var mapSvg = d3.select(".map-container").append("svg")
            .attr("width", width)
            .attr("height", height)
            .style("background", "#F9E4BC")
            .style("margin-bottom", "12px")
            .call(d3.zoom().on("zoom", zoom))
            .append("g");

        var chart = d3.select(".chart-container")
        var lineChart = d3.select(".line-chart")

        d3.json("europe.topojson").then(function (europe) {
            var data = topojson.feature(europe, europe.objects.europe);
            var states = mapSvg.selectAll("path.county")
                .data(data.features)
                .enter()
                .append("path")
                .attr("class", "county")
                .attr("id", function (d) { return d.id; })
                .attr("d", path)
                .style("fill", "blue")
                .style("stroke", "yellow")
                .style("stroke-width", 0.4)
                .style("stroke-opacity", 1);

            states.on('click', selectCountry);
            d3.json("sport.json").then(function (dataToLoad) {
                dataJson = dataToLoad;
                updateBarChart()
                updateLineChart()
            })
        });

        function showInfo(element) {
            console.log(this.id)
            console.log(dataJson[this.id][currentYear][currentSelectionFilter + currentSelectionUnit]);
        }

        function zoom(event) {
            mapSvg.attr("transform", event.transform);
        }

        function updateBarChart() {
            var svg, xAxis, yAxis, title, xAxisLabel;
            const width = 650;
            const height = 518;
            const marginTop = 30;
            const marginRight = 30;
            const marginBottom = 50;
            const marginLeft = 95;

            keys = Object.keys(dataJson)
            var names = [];
            var values = [];
            keys.forEach(key => {
                value = dataJson[key][currentYear][currentSelectionFilter + currentSelectionUnit]
                name = dataJson[key]["name"]
                if (value != null) {
                    values.push({ "name": name, "abbr": key, "value": value })
                }
            });

            if(sort == "desc") {
                values.sort((a, b) => a.value - b.value); 
            } else {
                values.sort((a, b) => b.value - a.value);
            }
            names = values.map(item => item.name);

            if (loadedBarChart == 0) {

                svg = chart
                    .append("svg")
                    .attr("id", "chart")
                    .attr("width", width)
                    .attr("height", height)
                    .style("background", "#F9E4BC")

                xAxis = svg
                    .append("g")
                    .attr("class", "xaxis")
                    .attr("transform", `translate(0,${height - marginBottom})`);

                yAxis = svg
                    .append("g")
                    .attr("class", "yaxis")
                    .attr("transform", `translate(${marginLeft},0)`);

                title = svg
                    .append("text")
                    .attr("class", "chart-title")
                    .attr("transform", `translate(${(width / 2) + 24},15)`)
                    .style("text-anchor", "middle")
                    .attr("fill", "blue");

                xAxisLabel = svg
                    .append("text")
                    .attr("class", "x-axis-label")
                    .attr("transform", `translate(${(width / 2) + 24},${height - marginBottom + 40})`)
                    .style("text-anchor", "middle");

                var buttonContainer = chart.append("div")
                    .attr("id", "button-container")
                    .style("position", "relative")
                    .style("bottom", "10px")
                    .style("right", "10px");

                buttonContainer.append("button")
                    .attr("id", "asc")
                    .text("Ascending")
                    .attr("class", "btn btn-outline-primary")
                    .on("click", function() {
                        if(sort === "desc") {
                            sort = "asc";
                            d3.select("#asc").attr("class", "btn btn-primary");
                            d3.select("#desc").attr("class", "btn btn-outline-primary");
                            updateBarChart();
                        }
                    });

                buttonContainer.append("button")
                    .attr("id", "desc")
                    .text("Descending")
                    .attr("class", "btn btn-primary")
                    .style("margin-left", "5px")
                    .on("click", function() {
                        if(sort === "asc") {
                            sort = "desc";
                            d3.select("#asc").attr("class", "btn btn-outline-primary");
                            d3.select("#desc").attr("class", "btn btn-primary");
                            updateBarChart();
                        }
                    });

                loadedBarChart = 1;
            } else {
                svg = d3.select("#chart");
                xAxis = svg.select(".xaxis");
                yAxis = svg.select(".yaxis");
                title = svg.select(".chart-title");
                xAxisLabel = svg.select(".x-axis-label");
            }


            const x = d3.scaleLinear()
                .domain([0, d3.max(values, function (d) { return d.value })])
                .range([marginLeft, width - marginRight]);

            const y = d3.scaleBand()
                .domain(names)
                .range([height - marginBottom, marginTop]).padding(0.25);

            if (currentSelectionUnit === "TH") {
                formatType = ".2s"
                xAxisLabel.text("Thousands of people");
            } else {
                formatType = ".1f"
                xAxisLabel.text("Percentage (%)");
            }

            xAxis
                .transition()
                .duration(500)
                .call(d3.axisBottom(x).tickFormat(d3.format(formatType)));

            yAxis.call(d3.axisLeft(y));

            title.text(currentTitleString);

            const rects = svg.selectAll("rect").data(values);

            rects.join(
                enter =>
                    enter
                        .append("rect")
                        .attr("x", x.range()[0])
                        .attr("y", (d) => y(d.name))
                        .attr("height", y.bandwidth())
                        .attr("fill", "blue")
                        .attr("width", d => {
                            return x(d.value) - x.range()[0];
                        }),
                update =>
                    update
                        .transition()
                        .duration(600)
                        .delay((d, i) => i * 10)
                        .attr("y", d => y(d.name))
                        .attr("height", y.bandwidth())
                        .attr("width", d => {
                            return x(d.value) - x.range()[0];
                        }),
                exit => exit.remove()
            );
        }

        function updateLineChart() {
            var svg, xAxis, yAxis, title, unitText, lineUnit;
            var groupIterator = 0;
            const width = 700;
            const height = 330;
            const marginTop = 30;
            const marginRight = 30;
            const marginBottom = 30;
            const marginLeft = 40;
            var colors = ["red", "green", "blue"]
            var showLegend = [false, false, false]

            years = ["2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021", "2022"]
            var valuesCombinded = [];

            currentGroup["data"].forEach(group => {
                var values = []
                years.forEach(year => {
                    value = dataJson[currentCountry][year][group["id"] + currentSelectionUnit]
                    if (value != null) {
                        values.push({ "year": year, "value": value })
                    }
                });
                valuesCombinded.push(values)
                if(values.length > 1){
                    showLegend[groupIterator] = true
                }
                groupIterator += 1
            });

            if (currentSelectionUnit === "TH") {
                unitText = "Thousands"
                formatType = ".2s"
            } else {
                unitText = "Percentage (%)"
                formatType = ".1f"
            }

            if (loadedLineChart == 0) {
                svg = lineChart.append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("viewBox", [0, 0, width, height])
                    .attr("style", "max-width: 100%; height: auto; height: intrinsic; background:#F9E4BC");

                xAxis = svg.append("g")
                    .attr("transform", `translate(0,${height - marginBottom})`)
                    .attr("class", "line-x-axis")

                yAxis = svg.append("g")
                    .attr("transform", `translate(${marginLeft},0)`)
                    .attr("class", "line-y-axis")
                    .call(g => g.select(".domain").remove())
                    .call(g => g.selectAll(".tick line").clone()
                        .attr("x2", width - marginLeft - marginRight)
                        .attr("stroke-opacity", 0.1))

                unit = yAxis.call(g => g.append("text")
                    .attr("x", -(marginLeft - 10))
                    .attr("y", 10)
                    .attr("id", "line-unit")
                    .attr("fill", "black")
                    .attr("text-anchor", "start")
                    .text(unitText))

                lineUnit = d3.select("#line-unit")

                title = svg
                    .append("text")
                    .attr("class", "line_chart_title")
                    .attr("transform", `translate(${width / 2},15)`)
                    .style("text-anchor", "middle")
                    .style("font-weight", "bold")
                    .attr("fill", "blue");

                paths = []

                for (let i = 0; i < currentGroup["data"].length; i++) {
                    paths.push(
                        svg.append("path")
                            .attr("class", "line")
                            .attr("fill", "none")
                            .attr("stroke", colors[i])
                            .attr("stroke-width", 3)
                    )
                }

                loadedLineChart = 1
            } else {
                svg = lineChart.select("svg")
                lineUnit = d3.select("#line-unit")
                xAxis = svg.select(".line-x-axis")
                yAxis = svg.select(".line-y-axis")
                title = svg.select(".line_chart_title")
                svg.select(".grid-lines").remove()
            }

            if (currentGroup["data"].length < paths.length) {
                var pathsLength = paths.length
                for (let i = 0; i < (pathsLength - currentGroup["data"].length); i++) {
                    paths[pathsLength - 1 - i].remove()
                    paths.pop()
                }
            } else if (paths.length < currentGroup["data"].length) {
                var pathsLength = paths.length
                for (let i = 0; i < (currentGroup["data"].length - pathsLength); i++) {
                    paths.push(
                        svg.append("path")
                            .attr("class", "line")
                            .attr("fill", "none")
                            .attr("stroke", colors[pathsLength + i])
                            .attr("stroke-width", 3)
                    )
                }
            }

            const x = d3.scaleUtc(d3.extent(years), [marginLeft, width - marginRight]);

            var y;

            if (false) { // values.length == 0 TO DO
                y = d3.scaleLinear()
                    .domain([0, 10])
                    .range([height - marginBottom, marginTop]);
            } else {
                y = d3.scaleLinear()
                    .domain([0, d3.max(valuesCombinded, function (values) {
                        return d3.max(values, function (d) { return d.value })
                    })])
                    .range([height - marginBottom, marginTop]);
            }

            lineUnit.text(unitText)
            title.text(currentGroup["print"] + " in " + dataJson[currentCountry]["name"])

            yGrid = (g) => g
                .attr('class', 'grid-lines')
                .selectAll('line')
                .data(y.ticks())
                .join('line')
                .attr('x1', marginLeft)
                .attr('x2', width - marginRight)
                .attr('y1', d => y(d))
                .attr('y2', d => y(d))
                .attr("stroke", "#000000")
                .attr("stroke-opacity", 0.25)

            xAxis.call(d3.axisBottom(x).ticks(width / 80).tickFormat(d3.format(".4")));

            yAxis.call(d3.axisLeft(y).ticks(height / 40).tickFormat(d3.format(formatType)))

            svg.append('g').call(yGrid)

            const line = d3.line()
                .x((d) => x(d.year))
                .y(d => y(d.value));

            for(let i=0; i<showLegend.length; i++) {
                d3.select(".color-line-chart-" + i).remove()
            }

            for (let i = 0; i < currentGroup["data"].length; i++) {
                paths[i].transition()
                    .duration(750)
                    .attr("d", line(valuesCombinded[i]));
                if (showLegend[i]) {
                    var colorContainer = d3.select(".line-chart-legend")
                        .append("div")
                        .attr("class", "color-line-chart-" + i)
                    colorContainer.append("div")
                        .attr("style", "height: 10px; width: 10px; background-color: " + colors[i])
                    colorContainer.append("div")
                        .attr("class", "color-text-" + i)
                        .text(currentGroup["data"][i]["print"])
                } else {
                    d3.select(".color-line-chart-" + i).remove()
                }
            }
        }

        function selectCountry(element) {
            currentCountry = this.id
            updateLineChart()
        }

        function updateFilterState(element) {
            var buttons = document.querySelectorAll(".filter-button")
            buttons.forEach(it => {
                it.classList.remove("btn-outline-primary");
                it.classList.remove("btn-primary");
                if (it != element) {
                    it.classList.add("btn-outline-primary");
                } else {
                    it.classList.add("btn-primary");
                }
            });
            currentTitleString = element.value
            currentSelectionFilter = element.id

            switch (currentSelectionFilter) {
                case "male":
                case "female":
                    currentGroup["print"] = "By gender"
                    currentGroup["data"] = gender
                    break;

                case "young":
                case "middle":
                case "old":
                    currentGroup["print"] = "By age"
                    currentGroup["data"] = age
                    break;

                case "primary":
                case "secondary":
                case "tertiary":
                    currentGroup["print"] = "By education level"
                    currentGroup["data"] = education
                    break;

                default:
                    currentGroup["print"] = "Total"
                    currentGroup["data"] = total
            }

            updateBarChart();
            updateLineChart();
        }

        function updateUnitState(element) {
            var buttons = document.querySelectorAll(".unit-button")
            buttons.forEach(it => {
                it.classList.remove("btn-outline-primary");
                it.classList.remove("btn-primary");
                if (it != element) {
                    it.classList.add("btn-outline-primary");
                } else {
                    it.classList.add("btn-primary");
                }
            });
            currentSelectionUnit = element.id
            updateBarChart();
            updateLineChart();
        }

        var intervalId;
        var isPlaying = false;
        var playPauseButton = d3.select("#play-pause-button");

        playPauseButton.on("click", function() {
            if (isPlaying) {
                clearInterval(intervalId);
                playPauseButton.text("Play");
                playPauseButton.attr("class", "btn btn-primary")
            } else {
                intervalId = setInterval(function() {
                    var currentValue = +slider.node().value;
                    if (currentValue < +slider.attr("max")) {
                        slider.node().value = currentValue + 1;
                    } else {
                        slider.node().value = slider.attr("min");
                    }
                    updateYear.call(slider.node());
                }, 1500);
                playPauseButton.text("Pause");
                playPauseButton.attr("class", "btn btn-danger")
            }
            isPlaying = !isPlaying;
        });

        function updateYear() {
            year.text(this.value)
            currentYear = this.value
            updateBarChart();
        }
    </script>
</body>

</html>